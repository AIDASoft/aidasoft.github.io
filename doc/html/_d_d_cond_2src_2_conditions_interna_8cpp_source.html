<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<!--BEGIN PROJECT_NAME--><title>DD4hep: DD4hep: /afs/cern.ch/user/m/mpetric/nightly_cppcheck/dd4hep/DDCond/src/ConditionsInterna.cpp Source File</title><!--END PROJECT_NAME-->
<!--BEGIN !PROJECT_NAME--><title>DD4hep: /afs/cern.ch/user/m/mpetric/nightly_cppcheck/dd4hep/DDCond/src/ConditionsInterna.cpp Source File</title><!--END !PROJECT_NAME-->
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="DD4hep.css" rel="stylesheet" type="text/css" />
$treeview
$search
$mathjax
</head>
<body>
<div id="top"><!-- do not remove this div! -->

<!--BEGIN TITLEAREA-->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 100px;">
  <!--BEGIN PROJECT_LOGO-->
  <td id="projectlogo"><img alt="Logo" src="../doc/LaTex/CERN-logo.png" height="72"/></td>
  <td id="projectlogo"><img alt="Logo" src="$projectlogo" height="72"/></td>
  <!--END PROJECT_LOGO-->
  <!--BEGIN PROJECT_NAME-->
  <td style="padding-left: 0.5em;">
   <!--BEGIN PROJECT_BRIEF--><div id="projectbrief">$projectbrief</div><!--END PROJECT_BRIEF-->
   <div id="projectname">DD4hep
   <!--BEGIN PROJECT_NUMBER-->&#160;<span id="projectnumber">Rev:exported</span><!--END PROJECT_NUMBER-->
   </div>
  </td>
  <!--END PROJECT_NAME-->
  <!--BEGIN !PROJECT_NAME-->
   <!--BEGIN PROJECT_BRIEF-->
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">$projectbrief</div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
  <!--BEGIN DISABLE_INDEX-->
   <!--BEGIN SEARCHENGINE-->
   <td>$searchbox</td>
   <!--END SEARCHENGINE-->
  <!--END DISABLE_INDEX-->
 </tr>
 </tbody>
</table>
</div>
<!--END TITLEAREA-->
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>/afs/cern.ch/user/m/mpetric/nightly_cppcheck/dd4hep/DDCond/src/ConditionsInterna.cpp</h1><a href="_d_d_cond_2src_2_conditions_interna_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// $Id$</span>
<a name="l00002"></a>00002 <span class="comment">//==========================================================================</span>
<a name="l00003"></a>00003 <span class="comment">//  AIDA Detector description implementation for LCD</span>
<a name="l00004"></a>00004 <span class="comment">//--------------------------------------------------------------------------</span>
<a name="l00005"></a>00005 <span class="comment">// Copyright (C) Organisation europeenne pour la Recherche nucleaire (CERN)</span>
<a name="l00006"></a>00006 <span class="comment">// All rights reserved.</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// For the licensing terms see $DD4hepINSTALL/LICENSE.</span>
<a name="l00009"></a>00009 <span class="comment">// For the list of contributors see $DD4hepINSTALL/doc/CREDITS.</span>
<a name="l00010"></a>00010 <span class="comment">//</span>
<a name="l00011"></a>00011 <span class="comment">// Author     : M.Frank</span>
<a name="l00012"></a>00012 <span class="comment">//</span>
<a name="l00013"></a>00013 <span class="comment">//==========================================================================</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="comment">// Framework include files</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="_l_c_d_d_8h.html">DD4hep/LCDD.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="_errors_8h.html">DD4hep/Errors.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="_plugins_8h.html">DD4hep/Plugins.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="_printout_8h.html">DD4hep/Printout.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="_world_8h.html">DD4hep/World.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="_handle_8inl.html">DD4hep/Handle.inl</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="_detector_tools_8h.html">DD4hep/DetectorTools.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_instance_count_8h.html">DD4hep/InstanceCount.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="_plugin_creators_8h.html">DD4hep/PluginCreators.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="_det_factory_helper_8h.html">DD4hep/DetFactoryHelper.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="_detector_interna_8h.html">DD4hep/objects/DetectorInterna.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="_d_d_core_2include_2_d_d4hep_2objects_2_conditions_interna_8h.html">DD4hep/objects/ConditionsInterna.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="_alignments_interna_8h.html">DD4hep/objects/AlignmentsInterna.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="_conditions_pool_8h.html">DDCond/ConditionsPool.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="_conditions_entry_8h.html">DDCond/ConditionsEntry.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="_conditions_manager_8h.html">DDCond/ConditionsManager.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="_conditions_data_loader_8h.html">DDCond/ConditionsDataLoader.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="_d_d_cond_2include_2_d_d_cond_2_conditions_interna_8h.html">DDCond/ConditionsInterna.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="_conditions_listener_8h.html">DDCond/ConditionsListener.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="_conditions_loader_imp_8h.html">DDCond/ConditionsLoaderImp.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="_alignments_loader_imp_8h.html">DDCond/AlignmentsLoaderImp.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="keyword">using namespace </span>std;
<a name="l00040"></a>00040 <span class="keyword">using namespace </span>DD4hep;
<a name="l00041"></a>00041 <span class="keyword">using namespace </span>DD4hep::Conditions;
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#ac09a1fb44c9ab0363a450f118f567286">00043</a> <span class="keyword">typedef</span> <a class="code" href="class_d_d4hep_1_1_alignments_1_1_alignments_loader.html" title="The data class behind a alignments container handle.">Alignments::AlignmentsLoader</a> <a class="code" href="class_d_d4hep_1_1_alignments_1_1_alignments_loader.html" title="The data class behind a alignments container handle.">AlignmentsLoader</a>;
<a name="l00044"></a><a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a4577998655a70ab228539800babb9642">00044</a> <span class="keyword">typedef</span> UpdatePool::UpdateEntries <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a4577998655a70ab228539800babb9642">Updates</a>;
<a name="l00045"></a><a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">00045</a> <span class="keyword">typedef</span> <a class="code" href="namespace_d_d4hep_1_1_conditions.html#ae765f0140a33973a430280f02b6062f4">RangeConditions</a> <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">RC</a>;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <a class="code" href="_handle_8inl.html#a9da33fd2046c253711abd9194ce5265a">DD4HEP_INSTANTIATE_HANDLE_NAMED</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html" title="Conditions internal namespace declaration.">ConditionsManagerObject</a>);
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#aa689d1f92db6113c8874a7dcd8bd7388">00049</a> <span class="preprocessor">#define NO_AGE 0</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="keyword">namespace </span>{
<a name="l00052"></a>00052   <span class="keyword">struct </span>Range {};
<a name="l00053"></a>00053   <span class="keyword">struct </span>Discrete {};
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <span class="keywordtype">int</span> s_debug = <a class="code" href="namespace_d_d4hep.html#a5b5a64d56252469451f2020a27d57d42aae10bc5a07787c36af0a4c9921b262d2">INFO</a>;
<a name="l00056"></a>00056 
<a name="l00058"></a>00058   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* check_iov_type(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html" title="Conditions internal namespace declaration.">ConditionsManagerObject</a>* o, <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>* iov);
<a name="l00059"></a>00059 
<a name="l00061"></a>00061   <span class="keyword">template</span> &lt;&gt; <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* check_iov_type&lt;void&gt;(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html" title="Conditions internal namespace declaration.">ConditionsManagerObject</a>* o, <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>* iov)   {
<a name="l00062"></a>00062     <span class="keywordflow">if</span> ( iov )  {
<a name="l00063"></a>00063       <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ = iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a885a5ed2be528cf1db783cade2a0b838">iovType</a> ? iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a885a5ed2be528cf1db783cade2a0b838">iovType</a> : o-&gt;iovType(iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a497f2859ca7cb011151ae6b977b50aa0" title="IOV buffer type: Must be a bitmap!">type</a>);
<a name="l00064"></a>00064       <span class="keywordflow">if</span> ( typ )  {
<a name="l00065"></a>00065         <span class="keywordflow">if</span> ( iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a497f2859ca7cb011151ae6b977b50aa0" title="IOV buffer type: Must be a bitmap!">type</a> == typ-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a> )  {
<a name="l00066"></a>00066           <span class="keywordflow">if</span> ( typ-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a> &lt; o-&gt;m_rawPool.size() )  {
<a name="l00067"></a>00067             <span class="keywordflow">if</span> ( o-&gt;m_rawPool[typ-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>] != 0 )  {
<a name="l00068"></a>00068               <span class="keywordflow">return</span> typ;
<a name="l00069"></a>00069             }
<a name="l00070"></a>00070           }
<a name="l00071"></a>00071         }
<a name="l00072"></a>00072       }
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074     <span class="keywordflow">return</span> 0;
<a name="l00075"></a>00075   }
<a name="l00076"></a>00076 
<a name="l00078"></a>00078   <span class="keyword">template</span> &lt;&gt; <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* check_iov_type&lt;Discrete&gt;(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html" title="Conditions internal namespace declaration.">ConditionsManagerObject</a>* o, <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>* iov)   {
<a name="l00079"></a>00079     <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ = check_iov_type&lt;void&gt;(o,iov);
<a name="l00080"></a>00080     <span class="keywordflow">if</span> ( typ &amp;&amp; !iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a9c942c869bb92e7b14b6d6308a6f15d7" title="Check if the IOV corresponds to a range.">has_range</a>() ) <span class="keywordflow">return</span> typ;
<a name="l00081"></a>00081     <span class="keywordflow">return</span> 0;
<a name="l00082"></a>00082   }
<a name="l00084"></a>00084   <span class="keyword">template</span> &lt;&gt; <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* check_iov_type&lt;Range&gt;(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html" title="Conditions internal namespace declaration.">ConditionsManagerObject</a>* o, <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>* iov)   {
<a name="l00085"></a>00085     <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ = check_iov_type&lt;void&gt;(o,iov);
<a name="l00086"></a>00086     <span class="keywordflow">if</span> ( typ &amp;&amp; iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a9c942c869bb92e7b14b6d6308a6f15d7" title="Check if the IOV corresponds to a range.">has_range</a>() ) <span class="keywordflow">return</span> typ;
<a name="l00087"></a>00087     <span class="keywordflow">return</span> 0;
<a name="l00088"></a>00088   }
<a name="l00089"></a>00089 
<a name="l00091"></a>00091   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keywordtype">void</span> __check_values__(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html" title="Conditions internal namespace declaration.">ConditionsManagerObject</a>* o, Condition::key_type key, <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>* iov)  
<a name="l00092"></a>00092   {
<a name="l00093"></a>00093     <span class="keywordflow">if</span> ( !iov )  {
<a name="l00094"></a>00094       <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Invalid IOV to access condition: %08X. [Null-reference]&quot;</span>,key);
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096     <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ = check_iov_type&lt;T&gt;(o,iov);
<a name="l00097"></a>00097     <span class="keywordflow">if</span> ( !typ )  {
<a name="l00098"></a>00098       <span class="comment">// Severe: We have an unknown IOV type. This is not allowed, </span>
<a name="l00099"></a>00099       <span class="comment">// because we do not known hot to handle it.....</span>
<a name="l00100"></a>00100       <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Invalid IOV type [%d] to access condition: %08X.&quot;</span>,
<a name="l00101"></a>00101              iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a497f2859ca7cb011151ae6b977b50aa0" title="IOV buffer type: Must be a bitmap!">type</a>, key);
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103   }
<a name="l00104"></a>00104 
<a name="l00106"></a>00106   <span class="keywordtype">bool</span> is_range_complete(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>&amp; iov, <span class="keyword">const</span> <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">RC</a>&amp; conditions)  {
<a name="l00107"></a>00107     <span class="keywordflow">if</span> ( !conditions.empty() )  {
<a name="l00108"></a>00108       <span class="comment">// We need to check if the entire range is covered.</span>
<a name="l00109"></a>00109       <span class="comment">// For every key.second we must find a key.first, which is at least as big</span>
<a name="l00110"></a>00110       IOV::Key test=iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a28eb02fd8d9c45b770e6a234303991de">keyData</a>;
<a name="l00111"></a>00111       <span class="comment">// The range may be returned unordered. Hence, </span>
<a name="l00112"></a>00112       <span class="comment">// we have to try to match at most conditions.size() times until we really know</span>
<a name="l00113"></a>00113       <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 0; j &lt; conditions.size(); ++j )  {
<a name="l00114"></a>00114         <span class="keywordflow">for</span>(RC::const_iterator i=conditions.begin(); i!=conditions.end(); ++i)  {
<a name="l00115"></a>00115           <span class="keyword">const</span> IOV::Key&amp; k = (*i)-&gt;iov-&gt;key();
<a name="l00116"></a>00116           <span class="keywordflow">if</span> ( k.first   &lt;= test.first+1 &amp;&amp; k.second &gt;= test.first  ) test.first = k.second;
<a name="l00117"></a>00117           <span class="keywordflow">if</span> ( k.first+1 &lt;= test.second  &amp;&amp; k.second &gt;= test.second ) test.second = k.first;
<a name="l00118"></a>00118           <span class="comment">//printout(INFO,&quot;Test&quot;,&quot;IOV: %ld,%ld --&gt; %ld,%ld&quot;,k.first,k.second, test.first, test.second);</span>
<a name="l00119"></a>00119           <span class="keywordflow">if</span> ( test.first &gt;= test.second ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121         <span class="keywordflow">if</span> ( test.first &lt;= iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a28eb02fd8d9c45b770e6a234303991de">keyData</a>.first &amp;&amp; test.second &gt;= iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a28eb02fd8d9c45b770e6a234303991de">keyData</a>.second ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00122"></a>00122       }
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00125"></a>00125   }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> PMF&gt;
<a name="l00128"></a>00128   <span class="keywordtype">void</span> __callListeners(<span class="keyword">const</span> ConditionsManagerObject::Listeners&amp; listeners, PMF pmf, <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a>&amp; cond)  {
<a name="l00129"></a>00129     <span class="keywordflow">for</span>(ConditionsManagerObject::Listeners::const_iterator i=listeners.begin(); i!=listeners.end(); ++i)  {
<a name="l00130"></a>00130       <span class="keyword">const</span> ConditionsManagerObject::Listener&amp; listener = *i;
<a name="l00131"></a>00131       (listener.first-&gt;*pmf)(cond, listener.second);
<a name="l00132"></a>00132     }
<a name="l00133"></a>00133   }
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00137"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#adff4e6fe39f5057945ff8ac0634aad2e">00137</a> ConditionsManagerObject::ConditionsManagerObject(LCDD&amp; lcdd_instance)
<a name="l00138"></a>00138   : <a class="code" href="class_d_d4hep_1_1_named_object.html" title="Implementation of a named object.">NamedObject</a>(), <a class="code" href="class_d_d4hep_1_1_object_extensions.html" title="Implementation of an object supporting arbitrary user extensions.">ObjectExtensions</a>(typeid(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html" title="Conditions internal namespace declaration.">ConditionsManagerObject</a>)), m_lcdd(lcdd_instance), m_iovTypes(), m_rawPool(), 
<a name="l00139"></a>00139     m_updateLock(), m_poolLock(), m_loader(),
<a name="l00140"></a>00140     m_updatePool(), 
<a name="l00141"></a>00141     locked(0)
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143   <a class="code" href="struct_d_d4hep_1_1_instance_count.html#aff4313ae357c0c3bcf3ce210eee4c470" title="Increment count according to type information.">InstanceCount::increment</a>(<span class="keyword">this</span>);
<a name="l00144"></a>00144   <a class="code" href="class_d_d4hep_1_1_property_configurable.html#af643f6873cc19432e566ecc1ba494c1d" title="Declare property.">declareProperty</a>(<span class="stringliteral">&quot;MaxIOVTypes&quot;</span>,         <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a8367e7cb7b833dee436e0eacb6c37a87" title="Property: maximal number of IOV types to be handled.">m_maxIOVTypes</a>=32);
<a name="l00145"></a>00145   <a class="code" href="class_d_d4hep_1_1_property_configurable.html#af643f6873cc19432e566ecc1ba494c1d" title="Declare property.">declareProperty</a>(<span class="stringliteral">&quot;PoolType&quot;</span>,            <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#acbd30bb422ca98796d1eabf4e17706a2" title="Property: ConditionsPool constructor type (default: empty. MUST BE SET!).">m_poolType</a>   = <span class="stringliteral">&quot;&quot;</span>);
<a name="l00146"></a>00146   <a class="code" href="class_d_d4hep_1_1_property_configurable.html#af643f6873cc19432e566ecc1ba494c1d" title="Declare property.">declareProperty</a>(<span class="stringliteral">&quot;UpdatePoolType&quot;</span>,      <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a015a2e784bea5773c62513f6d24af753" title="Property: UpdatePool constructor type (default: DD4hep_ConditionsLinearUpdatePool)...">m_updateType</a> = <span class="stringliteral">&quot;DD4hep_ConditionsLinearUpdatePool&quot;</span>);
<a name="l00147"></a>00147   <a class="code" href="class_d_d4hep_1_1_property_configurable.html#af643f6873cc19432e566ecc1ba494c1d" title="Declare property.">declareProperty</a>(<span class="stringliteral">&quot;UserPoolType&quot;</span>,        <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abe38ba943a936b6322ec553e53f0c7dd" title="Property: UserPool constructor type (default: DD4hep_ConditionsLinearUserPool).">m_userType</a>   = <span class="stringliteral">&quot;DD4hep_ConditionsMapUserPool&quot;</span>);
<a name="l00148"></a>00148   <a class="code" href="class_d_d4hep_1_1_property_configurable.html#af643f6873cc19432e566ecc1ba494c1d" title="Declare property.">declareProperty</a>(<span class="stringliteral">&quot;LoaderType&quot;</span>,          <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#adc2a8ecbe9ee734901bdf11dc2e3da0e" title="Property: Conditions loader type (default: &amp;quot;multi&amp;quot; -&amp;gt; DD4hep_Conditions_multi_Loader)...">m_loaderType</a> = <span class="stringliteral">&quot;multi&quot;</span>);
<a name="l00149"></a>00149   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>.resize(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a8367e7cb7b833dee436e0eacb6c37a87" title="Property: maximal number of IOV types to be handled.">m_maxIOVTypes</a>,<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>());
<a name="l00150"></a>00150   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>.resize(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a8367e7cb7b833dee436e0eacb6c37a87" title="Property: maximal number of IOV types to be handled.">m_maxIOVTypes</a>,0);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00154"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a78747f9367ce2e43b3d0ee4214eb9ab3">00154</a> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a78747f9367ce2e43b3d0ee4214eb9ab3" title="Default destructor.">ConditionsManagerObject::~ConditionsManagerObject</a>()   {
<a name="l00155"></a>00155   <a class="code" href="class_d_d4hep_1_1_geometry_1_1_world.html" title="Handle class to hold the information of the top DetElement object &amp;#39;world&amp;#39;...">Geometry::World</a> world(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a6ca16a780558379464d37ca9e691e9ef" title="Reference to main detector description object.">m_lcdd</a>.world());
<a name="l00156"></a>00156   for_each(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>.begin(), <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>.end(), <a class="code" href="class_d_d4hep_1_1_destroy_object.html" title="Functor to delete objects from heap and reset the pointer.">DestroyObject&lt;ConditionsIOVPool*&gt;</a>());
<a name="l00157"></a>00157   <span class="keywordflow">if</span> ( world.isValid() )  {
<a name="l00158"></a>00158     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_loader.html" title="The data class behind a conditions container handle.">ConditionsLoader</a>* cld = world-&gt;conditionsLoader;
<a name="l00159"></a>00159     <a class="code" href="class_d_d4hep_1_1_alignments_1_1_alignments_loader.html" title="The data class behind a alignments container handle.">AlignmentsLoader</a>* ald = world-&gt;alignmentsLoader;
<a name="l00160"></a>00160     world-&gt;conditionsLoader = 0;
<a name="l00161"></a>00161     world-&gt;alignmentsLoader = 0;
<a name="l00162"></a>00162     <span class="keywordflow">if</span> ( cld ) cld-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_loader.html#a0d1ad39d3ed19e648c673497c6995079" title="Release object. The client may not use any reference any further.">release</a>();
<a name="l00163"></a>00163     <span class="keywordflow">if</span> ( ald ) ald-&gt;<a class="code" href="class_d_d4hep_1_1_alignments_1_1_alignments_loader.html#acebda57b7dc5288116e7162dda92b65e" title="Release object. The client may not use any reference any further.">release</a>();
<a name="l00164"></a>00164   }
<a name="l00165"></a>00165   <a class="code" href="struct_d_d4hep_1_1_instance_count.html#a13975237d7100dab59a87dec2f67dc73" title="Decrement count according to type information.">InstanceCount::decrement</a>(<span class="keyword">this</span>);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a598756c7672c67065f3d116689f95722">00168</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a598756c7672c67065f3d116689f95722">ConditionsManagerObject::initialize</a>()  {
<a name="l00169"></a>00169   <span class="keywordflow">if</span> ( !<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a83ef3cf4c818d972d9c8720913c7525b" title="Reference to update conditions pool.">m_updatePool</a>.get() )  {
<a name="l00170"></a>00170     <span class="keywordtype">string</span> typ = <span class="stringliteral">&quot;DD4hep_Conditions_&quot;</span>+<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#adc2a8ecbe9ee734901bdf11dc2e3da0e" title="Property: Conditions loader type (default: &amp;quot;multi&amp;quot; -&amp;gt; DD4hep_Conditions_multi_Loader)...">m_loaderType</a>+<span class="stringliteral">&quot;_Loader&quot;</span>;
<a name="l00171"></a>00171     <span class="keyword">const</span> <span class="keywordtype">void</span>* argv_loader[] = {<span class="stringliteral">&quot;ConditionsDataLoader&quot;</span>, <span class="keyword">this</span>, 0};
<a name="l00172"></a>00172     <span class="keyword">const</span> <span class="keywordtype">void</span>* argv_pool[] = {<span class="keyword">this</span>, 0};
<a name="l00173"></a>00173     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a94483d902a20171f95eaf0e2d531f05d" title="Reference to data loader.">m_loader</a>.<a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html#aa6519c1c4d2d455b6b5cfad3318d5cc9" title="Assignment operator.">adopt</a>(createPlugin&lt;ConditionsDataLoader&gt;(typ,<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a6ca16a780558379464d37ca9e691e9ef" title="Reference to main detector description object.">m_lcdd</a>,2,argv_loader));
<a name="l00174"></a>00174     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a83ef3cf4c818d972d9c8720913c7525b" title="Reference to update conditions pool.">m_updatePool</a>.<a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html#aa6519c1c4d2d455b6b5cfad3318d5cc9" title="Assignment operator.">adopt</a>(createPlugin&lt;UpdatePool&gt;(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a015a2e784bea5773c62513f6d24af753" title="Property: UpdatePool constructor type (default: DD4hep_ConditionsLinearUpdatePool)...">m_updateType</a>,<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a6ca16a780558379464d37ca9e691e9ef" title="Reference to main detector description object.">m_lcdd</a>,1,argv_pool));
<a name="l00175"></a>00175     <span class="keywordflow">if</span> ( !<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a83ef3cf4c818d972d9c8720913c7525b" title="Reference to update conditions pool.">m_updatePool</a>.get() )  {
<a name="l00176"></a>00176       <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ The update pool of type %s cannot be created. [%s]&quot;</span>,
<a name="l00177"></a>00177              <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a015a2e784bea5773c62513f6d24af753" title="Property: UpdatePool constructor type (default: DD4hep_ConditionsLinearUpdatePool)...">m_updateType</a>.c_str(),<a class="code" href="namespace_d_d4hep_1_1_errors.html#a70d74e1cb3eced52822c830c2bf4990b" title="System error string for ENOSYS. Sets errno accordingly.">Errors::noSys</a>().c_str());
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179     <a class="code" href="class_d_d4hep_1_1_handle.html">Ref_t</a> ref(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a83ef3cf4c818d972d9c8720913c7525b" title="Reference to update conditions pool.">m_updatePool</a>.get());
<a name="l00180"></a>00180     ref-&gt;SetName(<span class="stringliteral">&quot;updates&quot;</span>);
<a name="l00181"></a>00181     ref-&gt;SetTitle(<span class="stringliteral">&quot;updates&quot;</span>);
<a name="l00182"></a>00182     <a class="code" href="class_d_d4hep_1_1_geometry_1_1_world.html" title="Handle class to hold the information of the top DetElement object &amp;#39;world&amp;#39;...">Geometry::World</a> world(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a6ca16a780558379464d37ca9e691e9ef" title="Reference to main detector description object.">m_lcdd</a>.world());
<a name="l00183"></a>00183     world-&gt;conditionsLoader = <span class="keyword">new</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_loader_imp.html" title="Concrete class to interface conditions loading from DetElements.">ConditionsLoaderImp</a>(<span class="keyword">this</span>);
<a name="l00184"></a>00184     world-&gt;alignmentsLoader = <span class="keyword">new</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_alignments_loader_imp.html" title="Concrete class to interface conditions loading from DetElements.">AlignmentsLoaderImp</a>(<span class="keyword">this</span>);
<a name="l00185"></a>00185   }
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ac945da1c9e23ba4e7db40221a38d4abc">00188</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ac945da1c9e23ba4e7db40221a38d4abc" title="Register a set of new managed condition for an IOV range. Called by __load_immediate...">ConditionsManagerObject::registerCallee</a>(Listeners&amp; listeners, <span class="keyword">const</span> Listener&amp; callee, <span class="keywordtype">bool</span> add)  {
<a name="l00189"></a>00189   <span class="keywordflow">if</span> ( add )  {
<a name="l00190"></a>00190     listeners.insert(callee);
<a name="l00191"></a>00191     <span class="keywordflow">return</span>;
<a name="l00192"></a>00192   }
<a name="l00193"></a>00193   Listeners::iterator i=listeners.find(callee);
<a name="l00194"></a>00194   <span class="keywordflow">if</span> ( i != listeners.end() ) listeners.erase(i);  
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00198"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a74aa106c194fb9ca929c8cf523632ce3">00198</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a74aa106c194fb9ca929c8cf523632ce3" title="(Un)Registration of conditions listeners with callback when a new condition is registered...">ConditionsManagerObject::callOnRegister</a>(<span class="keyword">const</span> Listener&amp; callee, <span class="keywordtype">bool</span> add)  {
<a name="l00199"></a>00199   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ac945da1c9e23ba4e7db40221a38d4abc" title="Register a set of new managed condition for an IOV range. Called by __load_immediate...">registerCallee</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a28a1e3f34a87dcd305b0f71bb92f297f" title="Conditions listeners on registration of new conditions.">m_onRegister</a>, callee, add);
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00203"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4a8912db5a30d6792455aef57c223bed">00203</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4a8912db5a30d6792455aef57c223bed" title="(Un)Registration of conditions listeners with callback when a condition is unregistered...">ConditionsManagerObject::callOnRemove</a>(<span class="keyword">const</span> Listener&amp; callee, <span class="keywordtype">bool</span> add)  {
<a name="l00204"></a>00204   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ac945da1c9e23ba4e7db40221a38d4abc" title="Register a set of new managed condition for an IOV range. Called by __load_immediate...">registerCallee</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aa6081a3511680ee1060e78b6a570636d" title="Conditions listeners on de-registration of new conditions.">m_onRemove</a>, callee, add);
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00208"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a872970f1bb67a3d225be8c63422f848f">00208</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a872970f1bb67a3d225be8c63422f848f" title="Listener invocation when a condition is registered to the cache.">ConditionsManagerObject::onRegister</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> condition)    {
<a name="l00209"></a>00209   __callListeners(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a28a1e3f34a87dcd305b0f71bb92f297f" title="Conditions listeners on registration of new conditions.">m_onRegister</a>, &amp;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_listener.html#a848d047b6a957987ea1a8256e6efd75a" title="ConditionsListener dummy implementation: onRegister new condition.">ConditionsListener::onRegisterCondition</a>, condition);
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00213"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#adb550d80aca3b897f299530b4c4bfd0b">00213</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#adb550d80aca3b897f299530b4c4bfd0b" title="Listener invocation when a condition is deregistered from the cache.">ConditionsManagerObject::onRemove</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> condition)   {
<a name="l00214"></a>00214   __callListeners(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aa6081a3511680ee1060e78b6a570636d" title="Conditions listeners on de-registration of new conditions.">m_onRemove</a>, &amp;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_listener.html#ab0c021c6ef8e6c47f28dd077220ee1f3" title="ConditionsListener dummy implementation: onRemove a condition.">ConditionsListener::onRemoveCondition</a>, condition);
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00218"></a>00218 <a class="code" href="classstd_1_1pair.html">pair&lt;bool, const IOVType*&gt;</a> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ace52e06206ed940af14fd32db36d5d08" title="Register new IOV type if it does not (yet) exist.">ConditionsManagerObject::registerIOVType</a>(<span class="keywordtype">size_t</span> iov_type, <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; iov_name)   {
<a name="l00219"></a>00219   <span class="keywordflow">if</span> ( iov_type&lt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>.size() )  {
<a name="l00220"></a>00220     <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>&amp; t = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>[iov_type];
<a name="l00221"></a>00221     <span class="keywordtype">bool</span> eq_type = t.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a> == iov_type;
<a name="l00222"></a>00222     <span class="keywordtype">bool</span> eq_name = t.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#ac4fa3d6c589f183137625501e757234e" title="String name.">name</a> == iov_name;
<a name="l00223"></a>00223     <span class="keywordflow">if</span> ( eq_type &amp;&amp; eq_name )  {
<a name="l00224"></a>00224       <span class="keywordflow">return</span> make_pair(<span class="keyword">false</span>,&amp;t);
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( t.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a> != 0 &amp;&amp; eq_type &amp;&amp; !eq_name )  {
<a name="l00227"></a>00227       <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;Cannot register IOV %s. Type %d already in use!&quot;</span>,
<a name="l00228"></a>00228              iov_name.c_str(), iov_type);
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     t.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#ac4fa3d6c589f183137625501e757234e" title="String name.">name</a> = iov_name;
<a name="l00231"></a>00231     t.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a> = iov_type;
<a name="l00232"></a>00232     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[t.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>] = <span class="keyword">new</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>();
<a name="l00233"></a>00233     <span class="keywordflow">return</span> make_pair(<span class="keyword">true</span>,&amp;t);    
<a name="l00234"></a>00234   }
<a name="l00235"></a>00235   <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;Cannot register IOV section %d of type %d. Value out of bounds: [%d,%d]&quot;</span>,
<a name="l00236"></a>00236          iov_name.c_str(), iov_type, 0, int(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>.size()));
<a name="l00237"></a>00237   <span class="keywordflow">return</span> make_pair(<span class="keyword">false</span>,(<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>*)0);
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00241"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a58a9d92f553861ae2d5fcf036a9b3d77">00241</a> <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a58a9d92f553861ae2d5fcf036a9b3d77" title="Access IOV by its type.">ConditionsManagerObject::iovType</a> (<span class="keywordtype">size_t</span> iov_type)<span class="keyword"> const  </span>{
<a name="l00242"></a>00242   <span class="keywordflow">if</span> ( iov_type&lt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>.size() )  {
<a name="l00243"></a>00243     <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>&amp; t = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>[iov_type];
<a name="l00244"></a>00244     <span class="keywordflow">if</span> ( t.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a> == iov_type ) <span class="keywordflow">return</span> &amp;t;
<a name="l00245"></a>00245   }
<a name="l00246"></a>00246   <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;Request to access an unregistered IOV type: %d.&quot;</span>, iov_type);
<a name="l00247"></a>00247   <span class="keywordflow">return</span> 0;
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00251"></a>00251 <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a58a9d92f553861ae2d5fcf036a9b3d77" title="Access IOV by its type.">ConditionsManagerObject::iovType</a> (<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; iov_name)<span class="keyword"> const   </span>{
<a name="l00252"></a>00252   <span class="keywordflow">for</span>( IOVTypes::const_iterator i=<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>.begin(); i != <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#abc6f28abb03bdfa1f3c0d51de6e6ac9d" title="Collection of IOV types managed.">m_iovTypes</a>.end(); ++i)
<a name="l00253"></a>00253     <span class="keywordflow">if</span> ( (*i).name == iov_name ) <span class="keywordflow">return</span> &amp;(*i);
<a name="l00254"></a>00254   <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;Request to access an unregistered IOV type: %s.&quot;</span>, iov_name.c_str());
<a name="l00255"></a>00255   <span class="keywordflow">return</span> 0;
<a name="l00256"></a>00256 }
<a name="l00257"></a>00257 
<a name="l00259"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a9ff0d68cbe3771a7a9354bdf518ddd11">00259</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a9ff0d68cbe3771a7a9354bdf518ddd11" title="Create IOV from string.">ConditionsManagerObject::fromString</a>(<span class="keyword">const</span> std::string&amp; data, <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>&amp; iov)   {
<a name="l00260"></a>00260   <span class="keywordtype">size_t</span> id1 = data.find(<span class="charliteral">&apos;,&apos;</span>);
<a name="l00261"></a>00261   <span class="keywordtype">size_t</span> id2 = data.find(<span class="charliteral">&apos;#&apos;</span>);
<a name="l00262"></a>00262   <span class="keywordflow">if</span> ( id2 == string::npos )  {
<a name="l00263"></a>00263     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Unknown IOV string representation: %s&quot;</span>,data.c_str());
<a name="l00264"></a>00264   }
<a name="l00265"></a>00265   <span class="keywordtype">string</span> iov_name = data.substr(id2+1);
<a name="l00266"></a>00266   <a class="code" href="class_d_d4hep_1_1_i_o_v.html#a07cb46dc875296dc9cccf4ff370104ae">IOV::Key</a> key;
<a name="l00267"></a>00267   <span class="keywordtype">int</span> nents = 0;
<a name="l00268"></a>00268   <span class="keywordflow">if</span> ( id1 != string::npos )
<a name="l00269"></a>00269     nents = ::sscanf(data.c_str(),<span class="stringliteral">&quot;%ld,%ld#&quot;</span>,&amp;key.first,&amp;key.second) == 2 ? 2 : 0;
<a name="l00270"></a>00270   <span class="keywordflow">else</span>  {
<a name="l00271"></a>00271     nents = ::sscanf(data.c_str(),<span class="stringliteral">&quot;%ld#&quot;</span>,&amp;key.first) == 1 ? 1 : 0;
<a name="l00272"></a>00272     key.second = key.first;
<a name="l00273"></a>00273   }
<a name="l00274"></a>00274   <span class="keywordflow">if</span> ( nents == 0 )   {
<a name="l00275"></a>00275     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,
<a name="l00276"></a>00276            <span class="stringliteral">&quot;+++ Failed to read keys from IOV string representation: %s&quot;</span>,data.c_str());
<a name="l00277"></a>00277   }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   <span class="comment">// Check if this IOV type is known</span>
<a name="l00280"></a>00280   <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a58a9d92f553861ae2d5fcf036a9b3d77" title="Access IOV by its type.">iovType</a>(iov_name);
<a name="l00281"></a>00281   <span class="keywordflow">if</span> ( !typ )  {
<a name="l00282"></a>00282     <span class="comment">// Severe: We have an unknown IOV type. This is not allowed, </span>
<a name="l00283"></a>00283     <span class="comment">// because we do not known hot to handle it.....</span>
<a name="l00284"></a>00284     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Unknown IOV type requested from data: %s. [%s]&quot;</span>,
<a name="l00285"></a>00285            data.c_str(),<a class="code" href="namespace_d_d4hep_1_1_errors.html#ab559bb58296daa1eed2725c602cb2483" title="System error string for EINVAL. Sets errno accordingly.">Errors::invalidArg</a>().c_str());
<a name="l00286"></a>00286   }
<a name="l00287"></a>00287   iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a497f2859ca7cb011151ae6b977b50aa0" title="IOV buffer type: Must be a bitmap!">type</a>    = typ-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>;
<a name="l00288"></a>00288   iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a885a5ed2be528cf1db783cade2a0b838">iovType</a> = typ;
<a name="l00289"></a>00289   iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#aa75452d30ebad70f84372091d6f777e4" title="Set discrete IOV value.">set</a>(key);
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00293"></a>00293 <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html" title="Class implementing the conditions collection for a given IOV type.">ConditionsPool</a>* <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aead446d145420ab3f6e48c74194dff05" title="Register IOV using new string data.">ConditionsManagerObject::registerIOV</a>(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; data)   {
<a name="l00294"></a>00294   <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a> iov(0);
<a name="l00295"></a>00295   <span class="comment">// Convert string to IOV</span>
<a name="l00296"></a>00296   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a9ff0d68cbe3771a7a9354bdf518ddd11" title="Create IOV from string.">fromString</a>(data, iov);
<a name="l00297"></a>00297   <span class="comment">// IOV read and checked. Now register it.</span>
<a name="l00298"></a>00298   <span class="comment">// The validity of iov-&gt;iovType is already ensured in &apos;fromString&apos;</span>
<a name="l00299"></a>00299   <span class="keywordflow">return</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aead446d145420ab3f6e48c74194dff05" title="Register IOV using new string data.">registerIOV</a>(*iov.iovType, iov.keyData);
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00303"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ac6647d16096a5fccda601eada638e13b">00303</a> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html" title="Class implementing the conditions collection for a given IOV type.">ConditionsPool</a>* <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aead446d145420ab3f6e48c74194dff05" title="Register IOV using new string data.">ConditionsManagerObject::registerIOV</a>(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>&amp; typ, <a class="code" href="class_d_d4hep_1_1_i_o_v.html#a07cb46dc875296dc9cccf4ff370104ae">IOV::Key</a> key)   {
<a name="l00304"></a>00304   <span class="comment">// IOV read and checked. Now register it, but always locked!</span>
<a name="l00305"></a>00305   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* pool = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[typ.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>];
<a name="l00306"></a>00306   <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> lock(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af0a0803e28ed3d30721609a420689e4a" title="Lock to protect the pool of all known conditions.">m_poolLock</a>);
<a name="l00307"></a>00307   <span class="keywordflow">if</span> ( !pool )  {
<a name="l00308"></a>00308     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[typ.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>] = pool = <span class="keyword">new</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>();
<a name="l00309"></a>00309   }
<a name="l00310"></a>00310   ConditionsIOVPool::Elements::const_iterator i = pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#adf0b418e513769d438a8c91d766e86f4" title="Container of IOV dependent conditions pools.">elements</a>.find(key);
<a name="l00311"></a>00311   <span class="keywordflow">if</span> ( i != pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#adf0b418e513769d438a8c91d766e86f4" title="Container of IOV dependent conditions pools.">elements</a>.end() )   {
<a name="l00312"></a>00312     <span class="keywordflow">return</span> (*i).second;
<a name="l00313"></a>00313   }
<a name="l00314"></a>00314   <span class="keyword">const</span> <span class="keywordtype">void</span>* argv_pool[] = {<span class="keyword">this</span>, 0};
<a name="l00315"></a>00315   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html" title="Class implementing the conditions collection for a given IOV type.">ConditionsPool</a>* cond_pool = createPlugin&lt;ConditionsPool&gt;(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#acbd30bb422ca98796d1eabf4e17706a2" title="Property: ConditionsPool constructor type (default: empty. MUST BE SET!).">m_poolType</a>,<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a6ca16a780558379464d37ca9e691e9ef" title="Reference to main detector description object.">m_lcdd</a>,1,argv_pool);
<a name="l00316"></a>00316   <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>* iov = <span class="keyword">new</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>(&amp;typ);
<a name="l00317"></a>00317   iov-&gt;type      = typ.<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>;
<a name="l00318"></a>00318   iov-&gt;keyData   = key;
<a name="l00319"></a>00319   cond_pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html#a5c86deb9085a420b2d8355ca835f3fc9" title="The IOV of the conditions hosted.">iov</a> = iov;
<a name="l00320"></a>00320   pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#adf0b418e513769d438a8c91d766e86f4" title="Container of IOV dependent conditions pools.">elements</a>.insert(make_pair(key,cond_pool));
<a name="l00321"></a>00321   <span class="keywordflow">return</span> cond_pool;
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00325"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a745cd16ef676c16294d450c60617fbd1">00325</a> <span class="keywordtype">bool</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a745cd16ef676c16294d450c60617fbd1" title="Register new condition with the conditions store. Unlocked version, not multi-threaded...">ConditionsManagerObject::registerUnlocked</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html" title="Class implementing the conditions collection for a given IOV type.">ConditionsPool</a>* pool, <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> cond)   {
<a name="l00326"></a>00326   <span class="keywordflow">if</span> ( pool &amp;&amp; cond.<a class="code" href="class_d_d4hep_1_1_handle.html#a4c5293aecb11989a708ec7615d0f0842" title="Check the validity of the object held by the handle.">isValid</a>() )  {
<a name="l00327"></a>00327     cond-&gt;pool = pool;
<a name="l00328"></a>00328     cond-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#ab22cbdbeece6355070483572b6a117fb" title="Access the IOV block.">iov</a>  = pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html#a5c86deb9085a420b2d8355ca835f3fc9" title="The IOV of the conditions hosted.">iov</a>;
<a name="l00329"></a>00329     pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html#a90abd47fd41d04d96b180aa244786b01" title="Register a new condition to this pool.">insert</a>(cond);
<a name="l00330"></a>00330     __callListeners(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a28a1e3f34a87dcd305b0f71bb92f297f" title="Conditions listeners on registration of new conditions.">m_onRegister</a>, &amp;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_listener.html#a848d047b6a957987ea1a8256e6efd75a" title="ConditionsListener dummy implementation: onRegister new condition.">ConditionsListener::onRegisterCondition</a>, cond);
<a name="l00331"></a>00331     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00332"></a>00332   }
<a name="l00333"></a>00333   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !pool )
<a name="l00334"></a>00334     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Unknown Conditions pool to register entry. [%s]&quot;</span>,
<a name="l00335"></a>00335            <a class="code" href="namespace_d_d4hep_1_1_errors.html#ab559bb58296daa1eed2725c602cb2483" title="System error string for EINVAL. Sets errno accordingly.">Errors::invalidArg</a>().c_str());
<a name="l00336"></a>00336   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !cond.<a class="code" href="class_d_d4hep_1_1_handle.html#a4c5293aecb11989a708ec7615d0f0842" title="Check the validity of the object held by the handle.">isValid</a>() )
<a name="l00337"></a>00337     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Invalid condition objects may not be registered. [%s]&quot;</span>,
<a name="l00338"></a>00338            <a class="code" href="namespace_d_d4hep_1_1_errors.html#ab559bb58296daa1eed2725c602cb2483" title="System error string for EINVAL. Sets errno accordingly.">Errors::invalidArg</a>().c_str());
<a name="l00339"></a>00339   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00340"></a>00340 }
<a name="l00341"></a>00341 
<a name="l00344"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ad22280768d433c68fabe8709a1bb6fda">00344</a> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ad22280768d433c68fabe8709a1bb6fda">ConditionsManagerObject::__queue_update</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_entry.html" title="The intermediate conditions data used to populate the DetElement conditions.">Conditions::Entry</a>* e)   {
<a name="l00345"></a>00345   <span class="keywordflow">if</span> ( e )  {
<a name="l00346"></a>00346     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html" title="Class implementing the conditions collection for a given IOV type.">ConditionsPool</a>*  p = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aead446d145420ab3f6e48c74194dff05" title="Register IOV using new string data.">registerIOV</a>(e-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_entry.html#a9a559618af3b8d15be51c806e40d1764" title="The validity string to be interpreted by the updating engine.">validity</a>);
<a name="l00347"></a>00347     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> condition(e-&gt;<a class="code" href="class_d_d4hep_1_1_named_object.html#a4675ccdc57835ec27eef8f2799eb77a2" title="The object name.">name</a>,e-&gt;<a class="code" href="class_d_d4hep_1_1_named_object.html#a8e17bb5f854b320302be44c68c39a192" title="The object type.">type</a>);
<a name="l00348"></a>00348     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html" title="The data class behind a conditions handle.">Condition::Object</a>* c = condition.<a class="code" href="class_d_d4hep_1_1_handle.html#a51a7d12a15a2a18977a0036bc6435cc8" title="Access to the held object.">ptr</a>();
<a name="l00349"></a>00349     <span class="comment">//c-&gt;name = e-&gt;name;</span>
<a name="l00350"></a>00350     <span class="comment">//  c-&gt;type = e-&gt;type;</span>
<a name="l00351"></a>00351     c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#a0b82a44322c732c5f5b99123eef28f63" title="Condition value (in string form).">value</a> = e-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_entry.html#a28dbb34f86ab05df22df9f9756100bcf" title="The actual conditions data.">value</a>;
<a name="l00352"></a>00352     c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#a4bd162e79c142737fd279493329bae42" title="Comment string.">comment</a> = <span class="stringliteral">&quot;----&quot;</span>;
<a name="l00353"></a>00353     c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#ac30708fd16161d507f475cc81419be18" title="Condition address.">address</a> = <span class="stringliteral">&quot;----&quot;</span>;
<a name="l00354"></a>00354     c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#a7f4bcc75be5d565396e3f09c91a23ede" title="Condition validity (in string form).">validity</a> = e-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_entry.html#a9a559618af3b8d15be51c806e40d1764" title="The validity string to be interpreted by the updating engine.">validity</a>;
<a name="l00355"></a>00355     c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#af04a3341b8791fbcf60fe5e5fff20166" title="Interval of validity.">iov</a>  = p-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html#a5c86deb9085a420b2d8355ca835f3fc9" title="The IOV of the conditions hosted.">iov</a>;
<a name="l00356"></a>00356     c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#a47997f68ec8b07ffe938d869726b6012" title="Reference to conditions pool.">pool</a> = p;
<a name="l00357"></a>00357     p-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html#a90abd47fd41d04d96b180aa244786b01" title="Register a new condition to this pool.">insert</a>(c);
<a name="l00358"></a>00358     <span class="keywordflow">if</span> ( s_debug &gt; <a class="code" href="namespace_d_d4hep.html#a5b5a64d56252469451f2020a27d57d42aae10bc5a07787c36af0a4c9921b262d2">INFO</a> )  {
<a name="l00359"></a>00359       <a class="code" href="namespace_d_d4hep.html#a6d434af620a49074f3d86d05a04b6073">printout</a>(<a class="code" href="namespace_d_d4hep.html#a5b5a64d56252469451f2020a27d57d42aae10bc5a07787c36af0a4c9921b262d2">INFO</a>,<span class="stringliteral">&quot;Conditions&quot;</span>,<span class="stringliteral">&quot;+++ Loaded condition: %s.%s to %s [%s] V: %s&quot;</span>,
<a name="l00360"></a>00360                e-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_entry.html#ae10613b25e5bc54df7d4ada0a2b774a9" title="Reference to the detector element.">detector</a>.<a class="code" href="class_d_d4hep_1_1_geometry_1_1_det_element.html#a6b70a5084294e7adb2f0bd0018e3aed2" title="Path of the detector element (not necessarily identical to placement path!).">path</a>().c_str(), c-&gt;<a class="code" href="class_d_d4hep_1_1_named_object.html#a4675ccdc57835ec27eef8f2799eb77a2" title="The object name.">name</a>.c_str(),
<a name="l00361"></a>00361                c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#a0b82a44322c732c5f5b99123eef28f63" title="Condition value (in string form).">value</a>.c_str(), c-&gt;<a class="code" href="class_d_d4hep_1_1_named_object.html#a8e17bb5f854b320302be44c68c39a192" title="The object type.">type</a>.c_str(), c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_interna_1_1_condition_object.html#a7f4bcc75be5d565396e3f09c91a23ede" title="Condition validity (in string form).">validity</a>.c_str());
<a name="l00362"></a>00362     }
<a name="l00363"></a>00363     <span class="keywordflow">return</span> c;
<a name="l00364"></a>00364   }
<a name="l00365"></a>00365   <span class="keywordflow">return</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a>();
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00369"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aca6c43594d93ab8773e245b8cffb0f60">00369</a> <span class="keywordtype">int</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aca6c43594d93ab8773e245b8cffb0f60" title="Clean conditions, which are above the age limit.">ConditionsManagerObject::clean</a>(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ, <span class="keywordtype">int</span> max_age)   {
<a name="l00370"></a>00370   <span class="keywordtype">int</span> count = 0;
<a name="l00371"></a>00371   <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> lock(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4da3e311e9b9121fef58f2cd80da12f9" title="Lock to protect the update/delayed conditions pool.">m_updateLock</a>);
<a name="l00372"></a>00372   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* pool = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[typ-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>];
<a name="l00373"></a>00373   <span class="keywordflow">if</span> ( pool )  {
<a name="l00374"></a>00374     count += pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#a3adc9fa6a89d3195b91b5fb11236f360" title="Remove all key based pools with an age beyon the minimum age.">clean</a>(max_age);
<a name="l00375"></a>00375   }
<a name="l00376"></a>00376   <span class="keywordflow">return</span> count;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00380"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a16cf2685ed249700904621d9a68bcdb2">00380</a> <a class="code" href="classstd_1_1pair.html">pair&lt;int,int&gt;</a> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a16cf2685ed249700904621d9a68bcdb2" title="Full cleanup of all managed conditions.">ConditionsManagerObject::clear</a>()   {
<a name="l00381"></a>00381   <a class="code" href="classstd_1_1pair.html">pair&lt;int,int&gt;</a> count(0,0);
<a name="l00382"></a>00382   <span class="keywordflow">for</span>( TypedConditionPool::iterator i=<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>.begin(); i != <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>.end(); ++i)  {
<a name="l00383"></a>00383     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* p = *i;
<a name="l00384"></a>00384     <span class="keywordflow">if</span> ( p )  {
<a name="l00385"></a>00385       ++count.first;
<a name="l00386"></a>00386       count.second += p-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#a3adc9fa6a89d3195b91b5fb11236f360" title="Remove all key based pools with an age beyon the minimum age.">clean</a>(0);
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388   }
<a name="l00389"></a>00389   <span class="keywordflow">return</span> count;
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00393"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a9bda89e54e1ad3b202f7295ec6c102a8">00393</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a9bda89e54e1ad3b202f7295ec6c102a8" title="Push all pending updates to the conditions store.">ConditionsManagerObject::pushUpdates</a>()   {
<a name="l00394"></a>00394   <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a4577998655a70ab228539800babb9642">Updates</a> entries;  {
<a name="l00395"></a>00395     <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> lock(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4da3e311e9b9121fef58f2cd80da12f9" title="Lock to protect the update/delayed conditions pool.">m_updateLock</a>);
<a name="l00396"></a>00396     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a83ef3cf4c818d972d9c8720913c7525b" title="Reference to update conditions pool.">m_updatePool</a>-&gt;popEntries(entries);
<a name="l00397"></a>00397   }
<a name="l00398"></a>00398   <span class="comment">// Lock global pool so that no other updates happen in the meanwhile</span>
<a name="l00399"></a>00399   <span class="comment">// which could kill the pool&apos;s containers</span>
<a name="l00400"></a>00400   <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> lock(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af0a0803e28ed3d30721609a420689e4a" title="Lock to protect the pool of all known conditions.">m_poolLock</a>);
<a name="l00401"></a>00401   <span class="keywordflow">for</span>(Updates::const_iterator iov_iter=entries.begin(); iov_iter!=entries.end(); ++iov_iter)  {
<a name="l00402"></a>00402     <span class="keyword">typedef</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_update_pool.html#ad6bcf36ae0a7dee0a08e1045d8612c6e">UpdatePool::ConditionEntries</a> <a class="code" href="_x_m_l_elements_8cpp.html#aadc18c9ee01d55f84c6bcd5841d0e4fd">_E</a>;
<a name="l00403"></a>00403     <span class="keyword">const</span> _E&amp; ents = (*iov_iter).second;
<a name="l00404"></a>00404     <span class="keywordflow">if</span> ( !ents.empty() )  {
<a name="l00405"></a>00405       <span class="keywordflow">for</span>(_E::const_iterator j=ents.begin(); j != ents.end(); ++j) {
<a name="l00406"></a>00406         (*j)-&gt;pool-&gt;insert(*j);
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409   }
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 <span class="preprocessor">#if 0</span>
<a name="l00413"></a>00413 <span class="preprocessor">long ConditionsManagerObject::prepare(const Condition::iov_type&amp; required_validity,</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span>                                      <a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html" title="Out version of the std auto_ptr implementation base either on auto_ptr or unique_ptr...">dd4hep_ptr&lt;UserPool&gt;</a>&amp; up)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416   <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ = check_iov_type&lt;Discrete&gt;(<span class="keyword">this</span>, &amp;required_validity);
<a name="l00417"></a>00417   <span class="keywordflow">if</span> ( typ )  {
<a name="l00418"></a>00418     <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">RC</a> valid, expired;
<a name="l00419"></a>00419     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* pool = m_rawPool[typ-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>];
<a name="l00420"></a>00420     <span class="keywordflow">if</span> ( 0 == up.get() || up-&gt;pool_type != ConditionsPool::USER_POOL_TYPE )  {
<a name="l00421"></a>00421       <span class="keyword">const</span> <span class="keywordtype">void</span>* argv_pool[] = {<span class="keyword">this</span>, 0};
<a name="l00422"></a>00422       <a class="code" href="class_d_d4hep_1_1_conditions_1_1_user_pool.html" title="Interface for conditions pool optimized to host conditions updates.">UserPool</a>* cp = createPlugin&lt;UserPool&gt;(m_userType,m_lcdd,1,argv_pool);
<a name="l00423"></a>00423       up.adopt(cp);
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_user_pool.html" title="Interface for conditions pool optimized to host conditions updates.">UserPool</a> *user_pool = up.get();
<a name="l00427"></a>00427     <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">Condition::iov_type</a> pool_iov(typ);
<a name="l00428"></a>00428     pool_iov.reset().invert();
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     pushUpdates();
<a name="l00431"></a>00431     pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#a75f43e7cd7cbc5c07afb0aca2b241a41" title="Retrieve a condition set given the key according to their validity.">select</a>(required_validity, valid, expired, pool_iov);
<a name="l00432"></a>00432     user_pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_user_pool.html#aa1b208b96c66bee13ee9f2bd6b7aaac5" title="Full cleanup of all managed conditions.">clear</a>();
<a name="l00433"></a>00433     user_pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_user_pool.html#af25760694df2897b8998fcf65ced5a18" title="Register a new condition to this pool.">insert</a>(valid);
<a name="l00434"></a>00434     <span class="keywordtype">long</span> num_expired = (long)expired.size();
<a name="l00435"></a>00435     <span class="keywordflow">if</span> ( num_expired &gt; 0 )  {
<a name="l00436"></a>00436       m_loader-&gt;update(required_validity, expired, pool_iov);
<a name="l00437"></a>00437       user_pool-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_user_pool.html#af25760694df2897b8998fcf65ced5a18" title="Register a new condition to this pool.">insert</a>(expired);
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439     user_pool-&gt;setValidity(pool_iov);
<a name="l00440"></a>00440     user_pool-&gt;setReqValidity(required_validity);
<a name="l00441"></a>00441     <span class="keywordflow">return</span> num_expired;
<a name="l00442"></a>00442   }
<a name="l00443"></a>00443   <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Unknown IOV type requested to enable conditions. [%s]&quot;</span>,
<a name="l00444"></a>00444          <a class="code" href="namespace_d_d4hep_1_1_errors.html#ab559bb58296daa1eed2725c602cb2483" title="System error string for EINVAL. Sets errno accordingly.">Errors::invalidArg</a>().c_str());
<a name="l00445"></a>00445   <span class="keywordflow">return</span> -1;
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 <span class="preprocessor">#endif</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span>
<a name="l00450"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4e7c5a6f766e182c7fcdcf766c28f9a0">00450</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4e7c5a6f766e182c7fcdcf766c28f9a0" title="Helper to check iov and user pool and create user pool if not present.">ConditionsManagerObject::__get_checked_pool</a>(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>&amp; req_iov,
<a name="l00451"></a>00451                                                  <a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html" title="Out version of the std auto_ptr implementation base either on auto_ptr or unique_ptr...">dd4hep_ptr&lt;UserPool&gt;</a>&amp; up)
<a name="l00452"></a>00452 {
<a name="l00453"></a>00453   <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v_type.html" title="Class describing the interval of validty type.">IOVType</a>* typ = check_iov_type&lt;Discrete&gt;(<span class="keyword">this</span>, &amp;req_iov);
<a name="l00454"></a>00454   <span class="keywordflow">if</span> ( typ )  {
<a name="l00455"></a>00455     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* pool = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[typ-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v_type.html#a8387532d69591a4379b8f84fa2302c5a" title="integer identifier ised internally">type</a>];
<a name="l00456"></a>00456     <span class="keywordflow">if</span> ( 0 == up.get() )  {
<a name="l00457"></a>00457       <span class="keyword">const</span> <span class="keywordtype">void</span>* argv[] = {<span class="keyword">this</span>, pool, 0};
<a name="l00458"></a>00458       <a class="code" href="class_d_d4hep_1_1_conditions_1_1_user_pool.html" title="Interface for conditions pool optimized to host conditions updates.">UserPool</a>* p = createPlugin&lt;UserPool&gt;(m_userType,m_lcdd,2,argv);
<a name="l00459"></a>00459       up.<a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html#aa6519c1c4d2d455b6b5cfad3318d5cc9" title="Assignment operator.">adopt</a>(p);
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461     <span class="keywordflow">return</span>;
<a name="l00462"></a>00462   }
<a name="l00463"></a>00463   <span class="comment">// Invalid IOV type. Throw exception</span>
<a name="l00464"></a>00464   <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Unknown IOV type requested to enable conditions. [%s]&quot;</span>,
<a name="l00465"></a>00465          <a class="code" href="namespace_d_d4hep_1_1_errors.html#ab559bb58296daa1eed2725c602cb2483" title="System error string for EINVAL. Sets errno accordingly.">Errors::invalidArg</a>().c_str());
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00469"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a897ca111b081fb1c6ed8a39739684d0e">00469</a> <span class="keywordtype">long</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a897ca111b081fb1c6ed8a39739684d0e" title="Prepare all updates for the given keys to the clients with the defined IOV.">ConditionsManagerObject::prepare</a>(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>&amp;            req_iov,
<a name="l00470"></a>00470                                       <span class="keyword">const</span> ConditionKeys&amp;  keys,
<a name="l00471"></a>00471                                       <a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html" title="Out version of the std auto_ptr implementation base either on auto_ptr or unique_ptr...">dd4hep_ptr&lt;UserPool&gt;</a>&amp; up)
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473   <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">RC</a> valid, expired;
<a name="l00474"></a>00474   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4e7c5a6f766e182c7fcdcf766c28f9a0" title="Helper to check iov and user pool and create user pool if not present.">__get_checked_pool</a>(req_iov, up);
<a name="l00476"></a>00476   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a9bda89e54e1ad3b202f7295ec6c102a8" title="Push all pending updates to the conditions store.">pushUpdates</a>();
<a name="l00478"></a>00478   <span class="keywordflow">return</span> up-&gt;prepare(req_iov,keys);
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 
<a name="l00483"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a50cd5fe85ead70ca4a0561ca37cbc435">00483</a> <span class="keywordtype">long</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a897ca111b081fb1c6ed8a39739684d0e" title="Prepare all updates for the given keys to the clients with the defined IOV.">ConditionsManagerObject::prepare</a>(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>&amp;            req_iov,
<a name="l00484"></a>00484                                       <span class="keyword">const</span> ConditionKeys&amp;  keys,
<a name="l00485"></a>00485                                       <a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html" title="Out version of the std auto_ptr implementation base either on auto_ptr or unique_ptr...">dd4hep_ptr&lt;UserPool&gt;</a>&amp; up,
<a name="l00486"></a>00486                                       <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_dependency_collection.html" title="Collection of condition dependencies.">Dependencies</a>&amp;   dependencies,
<a name="l00487"></a>00487                                       <span class="keywordtype">bool</span>                  verify_dependencies)
<a name="l00488"></a>00488 {
<a name="l00489"></a>00489   <span class="keywordtype">long</span> num_raw_updates = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a897ca111b081fb1c6ed8a39739684d0e" title="Prepare all updates for the given keys to the clients with the defined IOV.">prepare</a>(req_iov, keys, up);
<a name="l00490"></a>00490   <span class="keywordflow">if</span> ( num_raw_updates &gt; 0 || verify_dependencies )   {
<a name="l00491"></a>00491     <span class="keywordtype">long</span> num_dep_updates = up-&gt;compute(dependencies);
<a name="l00492"></a>00492     <span class="keywordflow">return</span> num_raw_updates+num_dep_updates;
<a name="l00493"></a>00493   }
<a name="l00494"></a>00494   <span class="keywordflow">return</span> num_raw_updates;
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00498"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4550e641d43365715516abc3f82586e6">00498</a> <span class="keywordtype">long</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a897ca111b081fb1c6ed8a39739684d0e" title="Prepare all updates for the given keys to the clients with the defined IOV.">ConditionsManagerObject::prepare</a>(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">Condition::iov_type</a>&amp; req_iov, <a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html" title="Out version of the std auto_ptr implementation base either on auto_ptr or unique_ptr...">dd4hep_ptr&lt;UserPool&gt;</a>&amp; up)   {
<a name="l00499"></a>00499   <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">RC</a> valid, expired;
<a name="l00500"></a>00500   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4e7c5a6f766e182c7fcdcf766c28f9a0" title="Helper to check iov and user pool and create user pool if not present.">__get_checked_pool</a>(req_iov, up);
<a name="l00502"></a>00502   <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a9bda89e54e1ad3b202f7295ec6c102a8" title="Push all pending updates to the conditions store.">pushUpdates</a>();
<a name="l00504"></a>00504   <span class="keywordflow">return</span> up-&gt;prepare(req_iov);
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00508"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a12104037c413426d82374b639acd88e8">00508</a> <span class="keywordtype">long</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a897ca111b081fb1c6ed8a39739684d0e" title="Prepare all updates for the given keys to the clients with the defined IOV.">ConditionsManagerObject::prepare</a>(<span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">Condition::iov_type</a>&amp; req_iov,
<a name="l00509"></a>00509                                       <a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html" title="Out version of the std auto_ptr implementation base either on auto_ptr or unique_ptr...">dd4hep_ptr&lt;UserPool&gt;</a>&amp; up,
<a name="l00510"></a>00510                                       <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_dependency_collection.html" title="Collection of condition dependencies.">Dependencies</a>&amp; dependencies,
<a name="l00511"></a>00511                                       <span class="keywordtype">bool</span> verify_dependencies)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513   <span class="keywordtype">long</span> num_raw_updates = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a897ca111b081fb1c6ed8a39739684d0e" title="Prepare all updates for the given keys to the clients with the defined IOV.">prepare</a>(req_iov, up);
<a name="l00514"></a>00514   <span class="keywordflow">if</span> ( num_raw_updates &gt; 0 || verify_dependencies )   {
<a name="l00515"></a>00515     <span class="keywordtype">long</span> num_dep_updates = up-&gt;compute(dependencies);
<a name="l00516"></a>00516     <span class="keywordflow">return</span> num_raw_updates+num_dep_updates;
<a name="l00517"></a>00517   }
<a name="l00518"></a>00518   <span class="keywordflow">return</span> num_raw_updates;
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00522"></a><a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af839b57cfdda205e2555e757651423fd">00522</a> <span class="keywordtype">void</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af839b57cfdda205e2555e757651423fd" title="Register a new managed condition.">ConditionsManagerObject::registerCondition</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> c)    {
<a name="l00523"></a>00523   <a class="code" href="class_d_d4hep_1_1dd4hep__ptr.html" title="Out version of the std auto_ptr implementation base either on auto_ptr or unique_ptr...">dd4hep_ptr&lt;Condition::Object&gt;</a> cond(c.<a class="code" href="class_d_d4hep_1_1_handle.html#a51a7d12a15a2a18977a0036bc6435cc8" title="Access to the held object.">ptr</a>());
<a name="l00524"></a>00524   <span class="keywordflow">if</span> ( !cond.get() )  {
<a name="l00525"></a>00525     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Failed to register invalid handle.&quot;</span>);
<a name="l00526"></a>00526   }
<a name="l00527"></a>00527   <span class="keywordflow">if</span> ( !<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af4a66ea9d20e133cadd6e33a188d7f5b" title="Public access: if locked, DetElements stay intact and are not altered.">locked</a> )  {
<a name="l00528"></a>00528     <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>* iov = <span class="keyword">const_cast&lt;</span><a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">IOV</a>*<span class="keyword">&gt;</span>(cond-&gt;iov);
<a name="l00529"></a>00529     <span class="comment">// Check arguments. This also checks the existence of the proper pool</span>
<a name="l00530"></a>00530     __check_values__&lt;Discrete&gt;(<span class="keyword">this</span>,cond-&gt;hash,iov);
<a name="l00531"></a>00531     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* pool = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a497f2859ca7cb011151ae6b977b50aa0" title="IOV buffer type: Must be a bitmap!">type</a>];
<a name="l00532"></a>00532     { <span class="comment">// We are now modifying the pool: need to lock any access</span>
<a name="l00533"></a>00533       <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> lock(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af0a0803e28ed3d30721609a420689e4a" title="Lock to protect the pool of all known conditions.">m_poolLock</a>);
<a name="l00534"></a>00534       ConditionsIOVPool::Elements::iterator it = pool-&gt;elements.find(iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a28eb02fd8d9c45b770e6a234303991de">keyData</a>);
<a name="l00535"></a>00535       <span class="keywordflow">if</span> ( it != pool-&gt;elements.end() )  {
<a name="l00536"></a>00536         (*it).second-&gt;insert(c);
<a name="l00537"></a>00537         <span class="keywordflow">return</span>;
<a name="l00538"></a>00538       }
<a name="l00539"></a>00539       <span class="keyword">const</span> <span class="keywordtype">void</span>* argv_pool[] = {<span class="keyword">this</span>, 0};
<a name="l00540"></a>00540       <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html" title="Class implementing the conditions collection for a given IOV type.">ConditionsPool</a>* cp = createPlugin&lt;ConditionsPool&gt;(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#acbd30bb422ca98796d1eabf4e17706a2" title="Property: ConditionsPool constructor type (default: empty. MUST BE SET!).">m_poolType</a>,m_lcdd,1,argv_pool);
<a name="l00541"></a>00541       pool-&gt;elements.<a class="code" href="class_d_d4hep_1_1_conditions_1_1_user_pool.html#af25760694df2897b8998fcf65ced5a18" title="Register a new condition to this pool.">insert</a>(make_pair(iov-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a28eb02fd8d9c45b770e6a234303991de">keyData</a>,cp));
<a name="l00542"></a>00542       cp-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_pool.html#a90abd47fd41d04d96b180aa244786b01" title="Register a new condition to this pool.">insert</a>(c);
<a name="l00543"></a>00543       <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a872970f1bb67a3d225be8c63422f848f" title="Listener invocation when a condition is registered to the cache.">onRegister</a>(c);
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545     <span class="keywordflow">return</span>;
<a name="l00546"></a>00546   }
<a name="l00547"></a>00547   <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ You cannot register new conditions while the conditions manager is locked!&quot;</span>);
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00551"></a>00551 <span class="keywordtype">bool</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aa859ab1f2f920ff8b69869d27e3dd8d1" title="Retrieve a condition set given a Detector Element and the conditions name according...">ConditionsManagerObject::select</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#a7528efa762e8cc072ef80ea67c3531f9" title="Forward definition of the key type.">Condition::key_type</a> key,
<a name="l00552"></a>00552                                      <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">Condition::iov_type</a>&amp; req_validity,
<a name="l00553"></a>00553                                      <a class="code" href="namespace_d_d4hep_1_1_conditions.html#ae765f0140a33973a430280f02b6062f4">RangeConditions</a>&amp; conditions)   {
<a name="l00554"></a>00554   {
<a name="l00555"></a>00555     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* p = 0;
<a name="l00556"></a>00556     <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> locked_action(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af0a0803e28ed3d30721609a420689e4a" title="Lock to protect the pool of all known conditions.">m_poolLock</a>);
<a name="l00557"></a>00557     p = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[req_validity.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a497f2859ca7cb011151ae6b977b50aa0" title="IOV buffer type: Must be a bitmap!">type</a>]; <span class="comment">// Existence already checked by caller!</span>
<a name="l00558"></a>00558     p-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#a75f43e7cd7cbc5c07afb0aca2b241a41" title="Retrieve a condition set given the key according to their validity.">select</a>(key, req_validity, conditions);
<a name="l00559"></a>00559   }
<a name="l00560"></a>00560   {
<a name="l00561"></a>00561     <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> locked_action(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4da3e311e9b9121fef58f2cd80da12f9" title="Lock to protect the update/delayed conditions pool.">m_updateLock</a>);
<a name="l00562"></a>00562     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a83ef3cf4c818d972d9c8720913c7525b" title="Reference to update conditions pool.">m_updatePool</a>-&gt;select_range(key, req_validity, conditions);
<a name="l00563"></a>00563   }
<a name="l00564"></a>00564   <span class="keywordflow">return</span> !conditions.empty();
<a name="l00565"></a>00565 }
<a name="l00566"></a>00566 
<a name="l00568"></a>00568 <span class="keywordtype">bool</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a64da19430050ca03c6ee43c83ca68dd9" title="Retrieve a condition set given a Detector Element and the conditions name according...">ConditionsManagerObject::select_range</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#a7528efa762e8cc072ef80ea67c3531f9" title="Forward definition of the key type.">Condition::key_type</a> key,
<a name="l00569"></a>00569                                            <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">Condition::iov_type</a>&amp; req_validity,
<a name="l00570"></a>00570                                            <a class="code" href="namespace_d_d4hep_1_1_conditions.html#ae765f0140a33973a430280f02b6062f4">RangeConditions</a>&amp; conditions)
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572   {
<a name="l00573"></a>00573     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html" title="Pool of conditions satisfying one IOV type (epoch, run, fill, etc).">ConditionsIOVPool</a>* p = 0;
<a name="l00574"></a>00574     <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> locked_action(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#af0a0803e28ed3d30721609a420689e4a" title="Lock to protect the pool of all known conditions.">m_poolLock</a>);
<a name="l00575"></a>00575     p = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a90c9b5060b3a6299aa7d5d4e9a0d8105" title="Managed pool of typed conditions indexed by IOV-type and IOV key.">m_rawPool</a>[req_validity.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a497f2859ca7cb011151ae6b977b50aa0" title="IOV buffer type: Must be a bitmap!">type</a>]; <span class="comment">// Existence alread checked by caller!</span>
<a name="l00576"></a>00576     p-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_i_o_v_pool.html#a09fb206aaa3c86d249598b7eaa58b322" title="Retrieve a condition set given the key according to their validity.">selectRange</a>(key, req_validity, conditions);
<a name="l00577"></a>00577   }
<a name="l00578"></a>00578   {
<a name="l00579"></a>00579     <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> locked_action(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4da3e311e9b9121fef58f2cd80da12f9" title="Lock to protect the update/delayed conditions pool.">m_updateLock</a>);
<a name="l00580"></a>00580     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a83ef3cf4c818d972d9c8720913c7525b" title="Reference to update conditions pool.">m_updatePool</a>-&gt;select_range(key, req_validity, conditions);
<a name="l00581"></a>00581   }
<a name="l00582"></a>00582   <span class="keywordflow">return</span> is_range_complete(req_validity,conditions);
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585 <span class="preprocessor">#if 0</span>
<a name="l00587"></a>00587 <span class="preprocessor">void ConditionsManagerObject::__register_immediate(RangeConditions&amp; rc)    {</span>
<a name="l00588"></a>00588 <span class="preprocessor"></span>  <span class="comment">// We modify the pool. For this we need a lock, </span>
<a name="l00589"></a>00589   <span class="comment">// since this may happen during the event processing in parallel</span>
<a name="l00590"></a>00590   <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> locked_action(m_poolLock);
<a name="l00591"></a>00591   <span class="keywordflow">for</span>(RC::iterator i=rc.begin(); i != rc.end(); ++i)   {
<a name="l00592"></a>00592     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> c = *i;
<a name="l00593"></a>00593     <span class="keywordflow">if</span> ( !c-&gt;pool )   {
<a name="l00594"></a>00594       <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ __register_immediate: Invalid pool. [Fatal, Internal or Usage Error]&quot;</span>);
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596     <span class="keywordflow">if</span> ( s_debug &gt; <a class="code" href="namespace_d_d4hep.html#a5b5a64d56252469451f2020a27d57d42aae10bc5a07787c36af0a4c9921b262d2">INFO</a> )  {
<a name="l00597"></a>00597       <a class="code" href="namespace_d_d4hep.html#a6d434af620a49074f3d86d05a04b6073">printout</a>(<a class="code" href="namespace_d_d4hep.html#a5b5a64d56252469451f2020a27d57d42aae10bc5a07787c36af0a4c9921b262d2">INFO</a>,<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ __register(1): %s [%s]&quot;</span>,
<a name="l00598"></a>00598                c.<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#ab4b94316f4df66998b750336ab14dc90" title="Access the name of the condition.">name</a>().c_str(), c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#ab22cbdbeece6355070483572b6a117fb" title="Access the IOV block.">iov</a>-&gt;str().c_str());
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600     c-&gt;pool-&gt;insert(c);
<a name="l00601"></a>00601   }
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 <span class="preprocessor">#endif</span>
<a name="l00604"></a>00604 <span class="preprocessor"></span>
<a name="l00606"></a>00606 <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a>
<a name="l00607"></a>00607 <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aa2b1c984fdda098cfbaba3e9ed09accd" title="Retrieve a condition set given a Detector Element and the conditions name according...">ConditionsManagerObject::get</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#a7528efa762e8cc072ef80ea67c3531f9" title="Forward definition of the key type.">Condition::key_type</a> key, <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">Condition::iov_type</a>&amp; iov)
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609   <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">RC</a> conditions;
<a name="l00610"></a>00610   __check_values__&lt;Discrete&gt;(<span class="keyword">this</span>, key, &amp;iov);
<a name="l00611"></a>00611   <span class="keywordtype">bool</span> rc = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#aa859ab1f2f920ff8b69869d27e3dd8d1" title="Retrieve a condition set given a Detector Element and the conditions name according...">select</a>(key, iov, conditions);
<a name="l00612"></a>00612   <span class="keywordflow">if</span> ( !rc )  {
<a name="l00613"></a>00613     <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> locked_load(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4da3e311e9b9121fef58f2cd80da12f9" title="Lock to protect the update/delayed conditions pool.">m_updateLock</a>);
<a name="l00614"></a>00614     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a94483d902a20171f95eaf0e2d531f05d" title="Reference to data loader.">m_loader</a>-&gt;load(key, iov, conditions);
<a name="l00615"></a>00615   }
<a name="l00616"></a>00616   <span class="keywordflow">if</span> ( conditions.size() == 1 )   {
<a name="l00617"></a>00617     conditions[0]-&gt;flags |= <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#a22825c02029e39fd0aa95c08c9be56d9a6a6c6f47c2bd5105363d432f8e55fcfa">Condition::ACTIVE</a>;
<a name="l00618"></a>00618     <span class="keywordflow">return</span> conditions[0];
<a name="l00619"></a>00619   }
<a name="l00620"></a>00620   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( conditions.empty() )   {
<a name="l00621"></a>00621     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Condition %08X for the requested IOV %s do not exist.&quot;</span>,
<a name="l00622"></a>00622            key, iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a52ef776877661a865c23e07d2e2c9bef" title="Create string representation of the IOV.">str</a>().c_str());
<a name="l00623"></a>00623   }
<a name="l00624"></a>00624   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( conditions.size() &gt; 1 )  {
<a name="l00625"></a>00625     RC::const_iterator start = conditions.begin();
<a name="l00626"></a>00626     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> first = *start;
<a name="l00627"></a>00627     <a class="code" href="namespace_d_d4hep.html#a6d434af620a49074f3d86d05a04b6073">printout</a>(<a class="code" href="namespace_d_d4hep.html#a5b5a64d56252469451f2020a27d57d42a54d5c1b9254fdf017c456cb972d26f96">ERROR</a>,<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Condition %s [%08X] is ambiguous for IOV %s:&quot;</span>,
<a name="l00628"></a>00628              first.<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#ab4b94316f4df66998b750336ab14dc90" title="Access the name of the condition.">name</a>().c_str(), key, iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a52ef776877661a865c23e07d2e2c9bef" title="Create string representation of the IOV.">str</a>().c_str());
<a name="l00629"></a>00629     <span class="keywordflow">for</span>(RC::const_iterator i=start; i!=conditions.end(); ++i)  {
<a name="l00630"></a>00630       <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a> c = *i;
<a name="l00631"></a>00631       <a class="code" href="namespace_d_d4hep.html#a6d434af620a49074f3d86d05a04b6073">printout</a>(<a class="code" href="namespace_d_d4hep.html#a5b5a64d56252469451f2020a27d57d42a54d5c1b9254fdf017c456cb972d26f96">ERROR</a>,<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ %s [%s] = %s&quot;</span>,
<a name="l00632"></a>00632                c.<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#ab4b94316f4df66998b750336ab14dc90" title="Access the name of the condition.">name</a>().c_str(), c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#ab22cbdbeece6355070483572b6a117fb" title="Access the IOV block.">iov</a>-&gt;<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a52ef776877661a865c23e07d2e2c9bef" title="Create string representation of the IOV.">str</a>().c_str(), c-&gt;<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#a2380234fddc3c50888eaf57ae60948f0" title="Access the value field of the condition as a string.">value</a>.c_str());
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Condition %s [%08X] is ambiguous for IOV %s:&quot;</span>,
<a name="l00635"></a>00635            first.<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#ab4b94316f4df66998b750336ab14dc90" title="Access the name of the condition.">name</a>().c_str(), key, iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a52ef776877661a865c23e07d2e2c9bef" title="Create string representation of the IOV.">str</a>().c_str());
<a name="l00636"></a>00636   }
<a name="l00637"></a>00637   <span class="keywordflow">return</span> <a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html" title="Main condition object handle.">Condition</a>();
<a name="l00638"></a>00638 }
<a name="l00639"></a>00639 
<a name="l00641"></a>00641 <a class="code" href="namespace_d_d4hep_1_1_conditions.html#ae765f0140a33973a430280f02b6062f4">RangeConditions</a>
<a name="l00642"></a>00642 <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#ac1c07dfc605bd517d4edfcca2c4bd21a" title="Retrieve a condition given a Detector Element and the conditions name.">ConditionsManagerObject::getRange</a>(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_condition.html#a7528efa762e8cc072ef80ea67c3531f9" title="Forward definition of the key type.">Condition::key_type</a> key, <span class="keyword">const</span> <a class="code" href="class_d_d4hep_1_1_i_o_v.html" title="Class describing the interval of validty.">Condition::iov_type</a>&amp; iov)
<a name="l00643"></a>00643 {
<a name="l00644"></a>00644   <a class="code" href="_d_d_cond_2src_2_conditions_interna_8cpp.html#a71e82ba4bbbab6ac54ac7b08c37ef076">RC</a> conditions;
<a name="l00645"></a>00645   __check_values__&lt;Range&gt;(<span class="keyword">this</span>, key, &amp;iov);
<a name="l00646"></a>00646   <span class="keywordtype">bool</span> rc = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a64da19430050ca03c6ee43c83ca68dd9" title="Retrieve a condition set given a Detector Element and the conditions name according...">select_range</a>(key, iov, conditions);
<a name="l00647"></a>00647   <span class="keywordflow">if</span> ( rc )  {
<a name="l00648"></a>00648     <span class="keywordflow">return</span> conditions;
<a name="l00649"></a>00649   }
<a name="l00650"></a>00650   <span class="keywordflow">else</span>  {
<a name="l00651"></a>00651     <a class="code" href="struct_d_d4hep_1_1dd4hep__lock__t.html">dd4hep_lock_t</a> locked_load(<a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a4da3e311e9b9121fef58f2cd80da12f9" title="Lock to protect the update/delayed conditions pool.">m_updateLock</a>);
<a name="l00652"></a>00652     <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a94483d902a20171f95eaf0e2d531f05d" title="Reference to data loader.">m_loader</a>-&gt;load_range(key, iov, conditions);
<a name="l00653"></a>00653     <span class="keywordflow">if</span> ( conditions.empty() )  {
<a name="l00654"></a>00654       <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Conditions %08X for IOV %s do not exist.&quot;</span>,
<a name="l00655"></a>00655              key, iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a52ef776877661a865c23e07d2e2c9bef" title="Create string representation of the IOV.">str</a>().c_str());
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657     conditions.clear();
<a name="l00658"></a>00658   }
<a name="l00659"></a>00659   rc = <a class="code" href="class_d_d4hep_1_1_conditions_1_1_conditions_manager_object.html#a64da19430050ca03c6ee43c83ca68dd9" title="Retrieve a condition set given a Detector Element and the conditions name according...">select_range</a>(key, iov, conditions);
<a name="l00660"></a>00660   <span class="keywordflow">if</span> ( !rc )  {
<a name="l00661"></a>00661     <a class="code" href="namespace_d_d4hep.html#af8602b0b80e0c252cf28e5fbbc81abcc">except</a>(<span class="stringliteral">&quot;ConditionsManager&quot;</span>,<span class="stringliteral">&quot;+++ Conditions %08X for IOV %s do not exist.&quot;</span>,
<a name="l00662"></a>00662            key, iov.<a class="code" href="class_d_d4hep_1_1_i_o_v.html#a52ef776877661a865c23e07d2e2c9bef" title="Create string representation of the IOV.">str</a>().c_str());
<a name="l00663"></a>00663   }
<a name="l00664"></a>00664   <span class="keywordflow">return</span> conditions;
<a name="l00665"></a>00665 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<!--BEGIN GENERATE_TREEVIEW-->
    <li class="footer">$generatedby
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </li>
   </ul>
 </div>
<!--END GENERATE_TREEVIEW-->
<!--BEGIN !GENERATE_TREEVIEW-->
<hr class="footer"/><address class="footer"><small>
$generatedby &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.6.1
</small></address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>
